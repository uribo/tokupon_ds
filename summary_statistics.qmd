---
title: "データの特徴を捉える"
code-fold: false
---

```{r}
#| include: false
library(dplyr)
library(ggplot2)
library(ragg)
library(palmerpenguins)
```

```{r}
#| include: false
source("data-raw/zoo.R")
```

[データ分析の目的](intro.qmd#データ分析って何)の一つに「データを要約すること」があることを示しました。
それでは実際に、データの要約に取り組んでみましょう。
例として動物データの体長を表示します。

```{r}
#| code-fold: false
df_zoo$body_length_cm
```

このデータの特徴として言えることは何でしょうか？
動物データに含まれるわずか`r nrow(df_zoo)`件の数値でも、こうした数値の羅列からデータの特徴を説明することは困難です。
データ分析で扱うデータの件数は数千、数万となる場合もあり、一つ一つデータを見ていくことも
現実的ではありません。
そこでデータを要約するために**代表値**の計算や**データの可視化**が行われます。

## データの位置を示す代表値: 平均値、中央値、最頻値

数値の傾向を捉えるには、その値が位置する分布を考えることが重要になります。
そこで、まずは複数の数値の性質や特徴をよく表す代表値を調べてみましょう。
**代表値によるデータの要約は、データに含まれる数値が位置するところについて大まかに傾向を把握する**ために用いられます。
代表値という名前の通り、数値によるデータの表現方法となります。

代表値によるデータの要約方法にはさまざまなものがあります。代表的なものは**平均値**の計算です。
平均値の他に中央値、最頻値が代表値としてしばしば使われます。
それぞれの特徴をみていきましょう。

### 平均値

まず、代表値の代表として平均値を紹介します。
平均値にも複数の種類が存在しますが、ここではより一般的な**算術平均**を平均値の例として扱います[^ch3-1]。
算術平均とは、2個以上のデータ（データの数を$N$とします）があるとき、そのすべての数値を足し合わせて$N$で割った値のことです。

[^ch3-1]: 平均として使われるものには、算術平均の他に幾何平均や加重平均などがあります。

```{r}
#| code-fold: false
# 1,3,5,7,10の平均を求めましょう
x <- c(1, 10, 5, 3, 7)
# まずは対象の数値を足し合わせます
sum(x)
# 次に数値の数(5)によって足し合わせた数値を割り算します
sum(x) / length(x)

# mean()関数を用いて平均値を計算することもできます。
mean(x)
```

平均値はその言葉の通り、データの真ん中あたりを示す代表値です。
しかし、「あたり」という点に注意してください。
**平均値は必ずしもデータの真ん中を示す値ではありません**。

平均値を扱うときは<ruby>外れ値<rt>はずれち</rt></ruby>の影響を受けやすい性質があるを理解しておきましょう。
外れ値とはデータの中の極端に大きい・小さい値のことです。
次に示す、動物データの一部の動物の体重について平均値がどのくらいになるか考えてみましょう。

```{r}
#| df-print: kable
df_zoo_subset <- 
  df_zoo |> 
  arrange(weight_kg) |> 
  filter(name %in% c("ミーアキャット", "リスザル", "モルモット", "コツメカワウソ", "ホッキョクグマ")) |> 
  select(name, weight_kg)

df_zoo_subset
```


```{r}
#| code-fold: false
# 動物データの体重の平均はどのくらい？
df_zoo_subset$weight_kg
```

平均値は `r mean(df_zoo_subset$weight_kg)` です。
この平均よりも小さな動物は`r sum(df_zoo_subset$weight_kg <= mean(df_zoo_subset$weight_kg))`種もいたにも関わらずです。
この値をデータの真ん中と見なしても問題ないでしょうか。

データを見ると一番体重の大きなホッキョクグマが`r df_zoo_subset$weight_kg[5]`kgで、二番目に大きな動物とも`r df_zoo_subset$weight_kg[5] -df_zoo_subset$weight_kg[4]`kgも差があります。
**平均値が大きく釣り上げられてしまった原因は、ホッキョクグマの体重が他の動物に比べて極端に大きな値、外れ値であったため**です。
ホッキョクグマを除いたときの平均値は`r mean(df_zoo_subset$weight_kg[-5])`となります。
このように平均値はデータの中の外れ値によって大きく左右される特徴があり、注意が必要です（@fig-average_outlier）。

![平均値は外れ値の影響を受けやすい](images/average_outlier.png){#fig-average_outlier}

### 中央値

中央値は、すべてのデータを大きさの順番に並べたとき、大きい方と小さい方のちょうど真ん中にくる値を指します。
例えば得られている数値が`r x`の場合には数値の数は`r length(x)`個なので、その真ん中の順位は3になります。
この真ん中の順位にくる数値を中央値とします。

```{r}
# xの数値は大きさの順番になっていないので並び替える
sort(x)

sort(x)[3]

median(x)
```

中央値はデータの値に関わらず、順番だけを気にするために外れ値が含まれている場合でも影響を受けません。
先ほどの動物データの一部に対しても中央値を求めましょう。

```{r}
median(df_zoo_subset$weight_kg)
```

一方、数値の個数が偶数のときには真ん中の数を決めるのに悩んでしまいます。
例えば4つの数値からなるデータの中央値を求めようとすると、真ん中は2.5番目となってしまいます。データの中には2.5番目の値は含まれません。
このときは2番目と3番目の値の平均を中央値として利用します。

```{r}
# データの個数が偶数の場合の中央値の求め方
x <- c(1, 2, 4, 6)

mean(c(x[2], x[3]))

# median()関数で中央値を求められる
median(x)
```

### 四分位点

中央値の考え方を拡張したものとして四分位点があります。
これはデータを小さい方から並び替えたとき、**データ全体を均等な数からなる4つのグループに分ける3つの点（値）**のことを指します。
各グループ区切りの値となる点をそれぞれ第1四分位点（25パーセンタイル)）、第2四分位点（50パーセンタイル）、第3四分位点（75パーセンタイル）と呼びます。
第2四分位点はデータの値を並び替えたときの真ん中となる値、つまり中央値です。
また、パーセンタイルというのは値を小さい方から並び替えたときの最後の値の位置を100としたときの四分位点の位置を示す値です。
つまり最小値は0パーセンタイル、最大値は100パーセンタイルとなります。

ペンギンデータの口ばしの長さ (`flipper_length_mm`)について四分位点を確認しましょう。
まずはおさらいとして中央値を求めます。

```{r}
median(penguins$flipper_length_mm, na.rm = TRUE)
```

Rでは`quantile()`関数を使い四分位点を求めます。
また、`summary()`関数で出力される値からも四分位点を確認できます。

```{r}
quantile(penguins$flipper_length_mm, na.rm = TRUE)
```

`quantile()`関数の出力の25%、50%、75%の表示がそれぞれ第1四分位点、第2四分位点、第3四分位点です。
50%が中央値と同じ値になっている点を確認できました。

<!-- 文部科学省の中学校学習指導要領での解説との差を説明するべきか
ref) https://www.mext.go.jp/component/a_menu/education/micro_detail/__icsFiles/afieldfile/2019/03/18/1387018_004.pdf
pp. 120-121
-->

続いて`summary()`関数の出力結果を見てみます。
こちらは`1st Qu.`、`Median`、`3rd Qu.`が該当する項目です。
`Qu.`は四分位点を意味する英語のQuantileに由来する表記です。

```{r}
summary(penguins$flipper_length_mm)
```

平均値や中央値ではデータの位置を示す値として一つの値しかわからなかったのに対して、四分位点を用いることで、より多くの情報を得ることができるようになりました。
この四分位点を利用したデータの視覚的な表現方法として箱ヒゲ図があります。
箱ヒゲ図についてはこの章で後ほど登場します。

### 最頻値

最頻値はデータの中で最も頻繁に出現する値のことを言います。
クラスのテストの点数で、96点の人が3人と最も多かったとき、最頻値は96です。ただし92点の人が同様に3人いたときには96、92が最頻値となります。

```{r}
x <- 
  c(73, 58, 96, 61, 87, 54, 92, 92, 63, 80,
    92, 59, 77, 96, 62, 64, 64, 59, 76, 96)

# 各点数の人数を求めます
table(x)

# 最頻値を求めます
names(which(table(x) == max(table(x))))
```

上記の例は変数が離散変数の場合の最頻値の求め方でした。
連続変数の場合も手順は変わりませんが、数値を適当な間隔でまとめた階級を設定することで判断することがあります。

<!-- これについては後ほど、ヒストグラムを紹介するときに説明します。 -->

データの位置を示す代表値3種類を説明しました。
それではデータの特徴を捉えるのに、平均値、中央値、最頻値のどれを使うのが適切でしょうか。
よく使われるのは平均値ですが、だからと言って平均値がどのような時にも優れているわけではありません。
扱うデータの内容、注目する事柄によって重要な代表値は変わってきます。
[前の章](intro.qmd)で、テストの平均点よりも低かった場合の位置について考えましたが、
そのとき中央値を計算していれば、平均よりも低い点であってもクラスの上位に含まれる可能性があることがわかったはずです。

::: {.callout-tip .tokupon_none}
#### 動物データの代表値を計算しよう

動物データに対して平均値や中央値、最頻値を求めてみよう。
Rにはここで紹介した`mean()`や`median()`以外にも
代表値の算出を行う関数が用意されているよ。
それらについて調べて実行してみよう。

コードの例と解説は[練習問題](exercise.qmd)をみてね。
:::

## データのばらつきと分布の形

代表値によって、データが分布する大まかな位置を知ることができるようになりました。
一方で外れ値を含む平均値や単純な頻度で求める最頻値のように、分布の形を推定することはできません。
外れ値によって中心がずれているかもしれませんし、最頻値が中心であるという保証はないのです。

そこで今度はデータのもつばらつきを考えてみます。
データは代表値から離れて分布しているのか、代表値の周辺に集中しているのか。
データの大まかな中心としての代表値とそのばらつきを知ることで、データの分布についておおよその傾向が掴めるようになります。

ばらつき具合を数値で表現する方法として代表的なものに、範囲、分散、標準偏差があります。
ここでも動物データを例にして算出方法をみていきましょう。

範囲はもっとも単純で、データの最小値と最大値から求めます。
Rでは最小値、最大値を求める関数としてそれぞれ`min()`関数、`max()`関数が用意されています。
また、最小値・最大値を同時に出力する`range()`関数も利用できます。
これらの関数はいずれも対象の変数を与えることで計算が行われます。

```{r}
#| echo: true
#| code-fold: false
# 動物データの体長について最小値・最大値を求める
# bl ... body_lengthの略称として使います
min_bl <- 
  min(df_zoo$body_length_cm, na.rm = TRUE)
min_bl
max_bl <-
  max(df_zoo$body_length_cm, na.rm = TRUE)
max_bl

range(df_zoo$body_length_cm, na.rm = TRUE)
```

最小値と最大値がわかれば、次のその差を求めます。この値がデータのとりうる範囲となります。
**範囲により区間という意味でのデータのばらつきの程度がわかる**ようになります。

```{r}
#| echo: true
#| code-fold: false
# 動物データの体長の範囲
max_bl - min_bl

# このやり方でもOK
diff(range(df_zoo$body_length_cm, na.rm = TRUE))
```

範囲を求める際に使う数値はデータの最小値と最大値でした。
そのためいくつかの問題が発生します。
まず、最小値と最大値だけを見ているので、他の値については無視することになっています。
そのため分布がどうなっているかを具体的に知ることはできません。
加えて、最小値・最大値が外れ値となっているある場合に、範囲が過大評価となってしまう恐れがあります。
そこで次に、データのすべての値がもつ情報を利用する分散と、分散を利用した標準偏差を求めることにします。

分散とは、それぞれのデータが**平均値を中心としてどのように散らばっているかを示す**ものです。
分散を求めることで、例えばペンギンの各個体の体長が、平均値から全般的に近い値をしているのか、特定の個体が平均値よりも特段高い（あるいは低い）のか、はたまた体長が高い個体と低いがバラバラにいるのかがわかるようになります。

分散は次のように求めます。

1. 変数の値の平均値を出す
2. 変数の各値と平均値の差を求める（偏差と呼びます）
3. 2で求めた差を2乗する

**各値と平均値の差を求めたあと、その合計を計算すると、どんなデータであっても合計は０になります**。
平均値より小さい・大きい値との差を求めてその合計を出しているので、差を相殺することになっています。
これではばらつきを評価できません。
そこで分散を求める際には、その差を2乗し、値を足し合わせます。
ここまでの内容を整理すると次のように表現できます。

$$
分散 = \frac{変数の値と平均値の差の2乗の合計}{変数に含まれるデータ数} = \frac{\sum{(x_i - \bar{x})^2}}{N}
$$

上記の式は標本分散を求める式となっています。
Rにおける分散の算出は`var()`関数で行われますが、ここでの分散は不偏分散と呼ばれるもので
データの数から１引いた値で割る点で異なります。
ここまでの内容をおさらいしてみましょう。

```{r}
df <- 
  penguins |> 
  filter(species == "Adelie") |> 
  select(body_mass_g) |> 
  filter(!is.na(body_mass_g)) |> 
  slice_head(n = 5)

df <- 
  df |> 
  # 各値について偏差 deviation（平均よりもいくら大きいか小さいか）を求める
  mutate(deviation = body_mass_g - mean(df$body_mass_g, na.rm = TRUE))

df
```

```{r}
# 偏差の合計は0になる
sum(df$deviation)
```

```{r}
# 偏差の値はプラスとマイナスが混ざる
df$deviation

# 偏差は2乗することでプラスの値のみになる
df$deviation^2
```

```{r}
# 分散 variance ... ここでは不偏分散
sum(df$deviation^2) / (nrow(df) - 1)

# var()関数に対象の変数を直接与えて求めても良い
var(df$body_mass_g)
```

合計が０になる差に対して2乗するのではなく、絶対値をとり、その合計を求めたものを平均偏差と呼びます。
また、**分散について平方根を求めたものが標準偏差**となります。
標準偏差は散らばりの具合を見るための指標となります。

```{r}
# 標準偏差
sqrt(sum(df$deviation^2) / (nrow(df) - 1))

sqrt(var(df$body_mass_g))
```


標準偏差を求める際に平方根を利用する理由は、分散を求めたときに2乗したものを元に戻すためです。
具体的には2乗した場合に単位が変わってしまうものを元に戻す必要があるためです。
例えば、長さの単位としてセンチメートルで測ったものならば平方センチメートルとなり、面積の単位になってしまうのを防ぐ効果があります。

![標準偏差を導くまでの過程](images/variance_table.png)

### 分布の形

これまで見てきたように、代表値やデータのばらつきを調べることでデータがどのような値を持っているのか、その分布の傾向を掴むことができるようになりました。
一方でまだ分布の姿そのものについては明らかではありません。
これについては次の度数分布表やヒストグラム、箱ヒゲ図の作成により知ることができるようになります。

偏差値、誤差

### 正規分布

左右対称に山のような形をしている


### 箱ヒゲ図

散らばり具合を可視化する方法

中央値を太い線で描く

箱

箱から<ruby>髭<rt>ひげ</rt></ruby>が伸びているような図であることから箱ヒゲ図と呼ばれます。

```{r}
#| warning: false
#| dev: ragg_png
df_zoo |> 
  ggplot(aes(y = body_length_cm)) +
  geom_boxplot()

# 分類群ごとの箱ヒゲ図を描画
# あらかじめ中央値を計算し、グラフ上では中央値の並びで分類群が表示されるように
# 調整しています。
df_zoo |> 
  filter(!is.na(body_length_cm)) |> 
  group_by(taxon) |> 
  mutate(body_length_median = median(body_length_cm)) |> 
  ungroup() |> 
  mutate(taxon = forcats::fct_reorder(taxon, body_length_median)) |> 
  ggplot(aes(taxon, body_length_cm)) +
  geom_boxplot()
```

## データの分布

実験や観測により値が得られたら、まずは**度数分布表**を作ることから始めると全体の分布の状況を理解しやすい傾向があります。
度数分布表とはその名の通り、度数の分布を示す表を指します。
ある値がデータに含まれる数を<ruby>度数<rt>どすう</rt></ruby>または<ruby>頻度<rt>ひんど</rt></ruby>といいます。
データに対する度数がどのように分布するかを示すかを表したものが度数分布表です。

すべてのデータに対して、度数によって大まかな位置を集計することになるため、データの分布が明らかになります。

分布のグラフがどのような形になっているか

右に尻尾が長く伸びているような形 ... ロングテール型
べき分布
最頻値、中央値、平均値の順に並ぶ


![分類群ごとに何種類の動物がいるか数えてみよう](images/animal_species_count.png)

動物のデータセットの分類群に対して度数を求めると次のようになります。

```{r}
#| echo: true
#| df-print: kable
# 度数、頻度を英語で frequency といいます
count(df_zoo, taxon, name = "frequency")
```

対象が量的変数の場合は頻度を簡単に求めることができます。
それでは量的変数、特に連続変数に対し度数を求めるにはどうすれば良いでしょうか。
量的変数に対して連続変数では同じ値をとることが少ないです。
そのため連続変数の度数を求めるときは、**変数がとり得る値をいくつかの区間に分割した階級(class)を考えます**。
このときの区間の幅を階級幅と呼びます。

ペンギンデータに含まれる体重を例として、まずは階級分けのために、まずは変数の最小値と最大値を調べましょう。
Rでは最小値・最大値を調べるのに`range()`関数が利用できることを思い出しましょう。

```{r}
range(penguins$body_mass_g, na.rm = TRUE)
```

```{r}
#| code-fold: true
# range()関数を使わないでmin()関数やmax()関数を使っても良い
min(penguins$body_mass_g, na.rm = TRUE)
max(penguins$body_mass_g, na.rm = TRUE)
```


最小値と最大値がわかったところで、次は階級と階級幅を設定します。
階級はデータ中のすべての値が含まれるようにします。
ペンギンデータの体重の最小値は`r min(penguins$body_mass_g, na.rm = TRUE)`、最大値は`r max(penguins$body_mass_g, na.rm = TRUE)`ですので、
2000から7000までの階級を設定しておきましょう。
この場合、階級幅を区切りが良い1000とすると階級数は5つあることになります。

つづいて、階級ごとに含まれる値の件数を数えます。

```{r}
weight_freq <- 
  table(cut(penguins$body_mass_g, 
            breaks = seq(2000, 
                         7000, 
                         by = 1000),
            dig.lab = 4))

tibble::tibble(
  class = names(weight_freq),
  frequency = weight_freq)
```

以上の手順が量的変数に対する度数分布表の求め方です。
ペンギンデータの体重についての度数分布表を作成することができました。
3000から4000の区間に含まれる値が最も多く、その次に4000から5000の区間の値、そのほかの区間の値はわずかということがわかります。

```{r}
#| eval: false
hist(df_zoo$weight_kg, breaks = 10)$breaks
hist(df_zoo$weight_kg, breaks = 10)$counts
hist(df_zoo$weight_kg, breaks = 10)$density

hist(df_zoo$weight_kg, breaks = 10)$mids
```




::: {.callout-note .tokupon}
#### 適切な階級数はどうやって決めるの？

階級数を決める方法としては、最小値と最大値、データの範囲やデータ数などが参考になるよ。

でも階級数によってヒストグラムの見た目が変わると

適切かはわからないよね

スタージェスの公式

:::



データ中の度数をまとめて表形式にしたものは度数分布表と呼ばれます。

分類群の値ごとに同じデータがどれだけあるかをカウントして度数を求めます。


**度数分布表**は手元のデータの値をいくつかの階級に分割します。




数学は統計学的な考え方において必須ではありません。


量的変数はデータを度数分布表やヒストグラムに表わすことで、
その分布の形を調べることができます。

### ヒストグラム

代表値に対して、データを図で表現する方法を解説します。
ヒストグラム、箱ヒゲ図、散布図は数値を図で表すための方法として用いられます。

横軸に興味のある変数の階級、縦軸に階級内に含まれる度数を示します。



度数分布をグラフ化する方法の一つとして**ヒストグラム**があります。

```{r}
#| label: histogram_for_body_length
#| fig-cap: 動物の体長のヒストグラム
#| warning: false
#| dev: ragg_png
df_zoo |> 
  ggplot(aes(body_length_cm)) +
  geom_histogram(bins = 6)
```

<!-- ビンの数を変えるとヒストグラムの形も変わる -->

::: {.callout-warning}

#### 階級幅の異なるヒストグラム

階級の幅が一定でないヒストグラムが存在するよ。

:::


データに対する説得力を増すためにも使われます。

データの特徴を素早く捉えることができます。



## まとめ

## 参考文献・URL

- [@R300000001-I029539543-00]
- [@R300000001-I030715636-00]
- [@R300000001-I030221455-00]
