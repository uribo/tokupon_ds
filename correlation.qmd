---
title: "相関: 2変数の関係を調べる"
---

```{r}
#| include: false
source("data-raw/zoo.R")
```

```{r}
#| include: false
library(dplyr)
library(ggplot2)
library(patchwork)
library(palmerpenguins)
theme_set(new = theme_gray(base_family = "IPAGothic"))
```


[前章](summary_statistics.qmd)では、動物の体長や体重といった1つの変数を扱う方法を紹介しました。
データ分析では、1つ以上の変数を同時に扱い、それらの変数について意味や関係を明らかにする目的があります。
この章では、体長と体重、体重と分類群を一度に考える、つまり2変数の関係を見ていくことにします。
2つの変数の関係を表す概念としての相関の導入から、関係を表すための手法としての相関係数や散布図、クロス集計表について紹介します。
まずは関係という言葉自体について、データ分析の視点で扱われる2つの関係を説明します。

## データ分析における2つの関係

**データ分析における「関係」は複数の変数がともに変化する状態**を指します。
関係を扱うときには次に説明する**因果関係と<ruby>相関<rt>そうかん</rt></ruby>関係**の2種類があり、似たものでありながら異なる状態を示すもので注意が必要です。

本書の冒頭、[データ分析の目的](intro.qmd#データ分析って何)の中でみたように、
「ペンギンは翼の長さが大きい個体であれば口ばしの長さも大きくなる」はペンギンの体の部位の関係を示すものです。
こうした**変数の間の関連性を相関関係**といいます。
一方で、翼が長くなると口ばしが大きくなる、とするわけではありません。
逆も然りで、口ばしが大きくなれば翼が長くなるわけでもありません。
つまり、翼と口ばしの長さは、どちらかが大きくなればどちらかが大きくなることを説明するものではありません。
このような**原因から結果を伴う状態を因果関係**と言います。原因と結果の関係とも言えます。

ペンギンデータは野外に生息するペンギン個体の観測により得られたデータです。
各個体はここで観測していない年齢や食事の内容も異なるはずです。
その場合、翼や口ばしの長さに対する影響も当然変わると考えられます。
2つの変数の関連性は明らかですが、片方の変数が原因となり、もう片方の変数の値を決めている、
因果関係があるとは言えないのです。

因果関係を明らかにするのは容易ではありません。

因果関係がないものに因果関係を見出すことの危険性

擬似相関 ... ２つの変数に因果関係がないのに、見えない要因によって因果関係があるかのように推測されること

擬似相関の例として有名な話があります。
ある街でのアイスクリームの売り上げが最も高い時期には、熱中症の搬送者数も最も多いことが指摘されました。
この時、アイスクリームの売り上げ増が熱中症の原因（あるいは結果）であると主張されましたが、
アイスクリームの売り上げや熱中症の増加も実際には、気温の高さが原因となっています。
気温について無視し、2つの変数の関係を議論すること、特に因果関係の有無を判断することは危険です。
熱中症患者の増加を抑えるために、アイスクリームの販売を規制するなどの誤った対策が取られてしまう恐れがあります。
気温について考慮せずに分析を進めてしまうと、見せかけの因果関係を発生させてしまいます。
ここでの気温のような観測されていない変数を潜在変数といいます。

## 相関: 2つの変数の間の関係

2つの量的変数の関係性を明らかにするために、相関という考え方を導入します。
ペンギンデータでは翼と口ばしの長さの関係を見ました。
これらの変数のように、互いの値が増えれば片方も増えるという傾向を示す関係を正の相関関係といいます。
一方、片方の変数の値が増えたときにもう片方の値が減少する場合、負の相関関係があるといいます。
この2つの関係に加えて、相関にはもう一つの関係があります。
それは変数の間に関係が見られない状態です。このことを無相関と呼びます。

変数間の相関関係はグラフ上に表現すると傾向を掴みやすくなります。
**散布図**と呼ばれる2つの変数を視覚的に扱うグラフを利用して相関関係を整理してみましょう[^ch4-1]。
@fig-correlation に相関関係を表わす3つの状態を示しました。

```{r}
#| label: fig-correlation
#| fig-cap: 相関関係を示す3つの状態
#| fig-width: 12
#| fig-height: 4.6
#| dev: ragg_png
set.seed(123)
df_corr <- 
  tibble::tibble(
  x = rnorm(100),
  y = rnorm(100),
  y_positive = 5 * x + rnorm(100, sd = 3),
  y_negative = -5 * x + rnorm(100, sd = 4))

p1 <- 
  df_corr |> 
  ggplot(aes(x, y_positive)) +
  geom_point() +
  ylab("y") +
  labs(title = "正の相関関係")
p2 <- 
  df_corr |>  
  ggplot(aes(x, y)) +
  geom_point() +
  labs(title = "無相関")
p3 <- 
  df_corr |> 
  ggplot(aes(x, y_negative)) +
  geom_point() +
  ylab("y") +
  labs(title = "負の相関関係")

p1 + p2 + p3 + 
  plot_layout(ncol = 3)
```

[^ch4-1]: [はじめに](intro.qmd#データ分析って何)の中でペンギンデータの体の部位の関係を見たときに使われていた（@fig-penguins）のも散布図です。

### 相関係数

2つの変数の関係について、数値的に評価する方法として相関係数が用いられます。
**相関係数は2つの変数の間の直線的な関係の強さを評価する指標**です。
-1以上から1以下の値をとり、変数の関係が強いほど、散布図にしたときに直線関係に近いものほど、絶対値が1に近づきます。

相関係数にはいくつかの種類があり、中でもピアソンの積率相関係数が最も頻繁に利用されます[^ch4-2]。
本書でも、相関係数といった時にはピアソンの積率相関係数を指して使います。

[^ch4-2]: スピアマンの順位相関係数、ケンドールの順位相関係数などがあります。

::: {.callout-warning .tokupon_none}
#### 相関係数の注意点

相関係数はあくまでも変数の関係が直線関係にあることを仮定しているよ。
だから2変数間の関係が**直線的でないときは適切な計算が行えない**んだ。

また、相関係数は外れ値の影響を受けやすいよ。
外れ値とはデータに含まれる極端に小さい・大きい値のことだよ。
平均値が外れ値の影響を受けやすいということや、箱ヒゲ図を描画した際にも外れ値は他のデータと区別して表現していたことを思い出してね。
外れ値はデータ全体の傾向を大きく左右する影響があるから注意が必要なんだ。
:::

Rでは相関係数の算出を`cor.test()`関数によって行います。
@fig_correlation で示した3つの状態について、それぞれ相関係数を算出すると次の値になります。

```{r}
#| code-fold: false
cor.test(formula = ~ x + y_positive, data = df_corr) # 正の相関関係
cor.test(formula = ~ x + y, data = df_corr) # 無相関
cor.test(formula = ~ x + y_negative, data = df_corr) # 負の相関関係
```

```{r}
# 相関係数はデータの測定単位に依存しない
cor.test(scale(df_zoo$body_length_cm), 
         scale(df_zoo$weight_kg))
```


```{r}
# 動物データについて相関係数を求める
#| eval: false
cor.test(df_zoo$body_length_cm, df_zoo$weight_kg)
```

どんな変数間であろうと相関係数は必ず出る

相関係数は標準化された値どうしの共分散とも考えられる

繰り返しになりますが、相関係数は変数間の因果関係を示すものではありません。

外れ値が相関係数に及ぼす影響

### 散布図

2変数のデータに対するグラフ表現として**散布図**があります。
関心のある2つの量的変数を縦軸と横軸にとり、それぞれの値を2グラフ上に投影した図で、2変数の関係を示すために広く利用されます。

ペンギンデータの口ばしの長さと翼の長さの関係を散布図で表してみましょう。
まずはデータを確認します。

```{r}
#| tbl-cap: ペンギンデータの口ばしと翼の長さの値
#| df-print: paged
penguins |> 
  select(bill_length_mm, flipper_length_mm)
```

一見すると傾向が掴みにくい2変数の関係もグラフに表すことで関係を捉えやすくなります。
散布図で横軸に示す口ばしの長さも、縦軸に示す翼の長さもいずれも値が大きいほど、もう片方の値も大きいことがわかります。

```{r}
#| label: fig_zoo_body_length-weight_scatter
#| fig-cap: ペンギンデータの口ばしと翼の長さの散布図
penguins |> 
  ggplot(aes(bill_length_mm, flipper_length_mm)) +
  geom_point()
```

<!-- 共分散... データの測定単位に依存。平均からの偏差 -->

## クロス集計表

質的変数の変数間の関係を調べる方法を紹介します。
**ペンギンデータ**には、種の名前 species、生育する島の名前 island、性別 sex の3つの質的変数があります。
これらの質的変数間の関係を調べるためにクロス集計表を用います。

クロス集計表では、対象の質的変数に含まれる件数をカウントし、表にまとめます。
表の行・列には変数の項目が並びます。
@tbl-penguins_sp_islands にペンギンデータにおける島ごとの種数を整理しました。

```{r}
#| label: tbl-penguins_sp_islands
#| tbl-cap: ペンギンデータにおける島ごとの種数
#| warning: false
library(dplyr)
library(palmerpenguins)
penguins |> 
  count(species, island) |> 
  tidyr::pivot_wider(names_from = island, values_from = n, values_fill = 0)
```

この表を見るだけで次の事柄がわかります。

- アデリーペンギン Adelie は調査地のどの島にも生育する
- ヒゲペンギン Chinstrap はDream島にだけ生育する
- ジェンツーペンギン Gentoo はBiscoe島に多いがDreamやTorgersenには生育しない

クロス集計表の利用によって1変数を調べただけではわからなかった質的変数の特徴を知ることができました。

クロス集計表によって、データの比較が行いやすくなりましたが、
その差は本当にデータの性質を反映しているのでしょうか。
統計的な手法を用いることで、このような差の有無を判断できるようになります。
「なんとなく差がある」結果を**統計的仮説検定**を行うことで客観的に評価できるようになります。

## まとめと課題

- 相関の例を探してみよう。擬似相関や因果関係とは違うか考えてみよう。

## 参考文献・URL

- [@R300000001-I030221455-00]
- [@R300000001-I031803943-00]
- [@R300000001-I030185215-00]
